using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Omnia.CLI.Commands.Model.Apply;
using Shouldly;
using Xunit;

namespace UnitTests.Commands.Model.Apply
{
    public class FormElementPathFinderTest
    {
        private const string FormMetadata = "{\"name\":\"CustomerForm\",\"type\":\"Form\",\"label\":\"Customer\",\"entity\":\"Customer\",\"elements\":[{\"row\":1,\"name\":\"_code\",\"size\":6,\"type\":\"Input\",\"label\":\"Code\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":1,\"name\":\"_name\",\"size\":6,\"type\":\"Input\",\"label\":\"Name\",\"column\":7,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":2,\"name\":\"_description\",\"size\":6,\"type\":\"Input\",\"label\":\"Description\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":2,\"name\":\"_inactive\",\"size\":6,\"type\":\"Input\",\"label\":\"Inactive\",\"column\":7,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Boolean\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":5,\"name\":\"_state\",\"size\":6,\"type\":\"Selector\",\"label\":\"State\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"enumeration\",\"value\":\"CustomerStateMachineStates\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":6,\"name\":\"_assigned\",\"size\":6,\"type\":\"Input\",\"label\":\"Assigned\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":10,\"name\":\"Dates\",\"size\":12,\"type\":\"Container\",\"label\":\"Dates\",\"column\":1,\"elements\":[{\"row\":1,\"name\":\"Today\",\"size\":10,\"type\":\"Input\",\"label\":\"Today\",\"column\":1,\"elements\":[],\"helpText\":\"\",\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Date\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":\"Mobile\"}],\"helpText\":\"\",\"isHidden\":false,\"attributes\":[],\"behaviours\":[],\"description\":null,\"visibleFrom\":\"Mobile\"},{\"row\":7,\"name\":\"NoteList\",\"size\":12,\"type\":\"List\",\"label\":\"Note List\",\"column\":1,\"elements\":[{\"row\":0,\"name\":\"_code\",\"size\":3,\"type\":\"Input\",\"label\":\"Code\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":1,\"name\":\"_name\",\"size\":3,\"type\":\"Input\",\"label\":\"Name\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":2,\"name\":\"_description\",\"size\":3,\"type\":\"Input\",\"label\":\"Description\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":3,\"name\":\"_inactive\",\"size\":3,\"type\":\"Input\",\"label\":\"Inactive\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Boolean\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":4,\"name\":\"SubNotes\",\"size\":12,\"type\":\"List\",\"label\":\"Sub Notes\",\"column\":1,\"elements\":[{\"row\":0,\"name\":\"_code\",\"size\":3,\"type\":\"Input\",\"label\":\"Code\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":1,\"name\":\"_name\",\"size\":3,\"type\":\"Input\",\"label\":\"Name\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":2,\"name\":\"_description\",\"size\":3,\"type\":\"Input\",\"label\":\"Description\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Text\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":3,\"name\":\"_inactive\",\"size\":3,\"type\":\"Input\",\"label\":\"Inactive\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"None\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"1\"},{\"key\":\"min\",\"value\":\"1\"},{\"key\":\"isSensitiveData\",\"value\":\"false\"},{\"key\":\"formattingType\",\"value\":\"Boolean\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"Composite\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"100\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"definition\",\"value\":\"SubNotes\"},{\"key\":\"isEditable\",\"value\":\"true\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"aggregationKind\",\"value\":\"Composite\"},{\"key\":\"isReadOnly\",\"value\":\"false\"},{\"key\":\"max\",\"value\":\"100\"},{\"key\":\"min\",\"value\":\"0\"},{\"key\":\"definition\",\"value\":\"Notes\"},{\"key\":\"isEditable\",\"value\":\"true\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"attributes\":[],\"behaviours\":[{\"name\":\"onInitialize\",\"type\":\"Initialize\",\"expression\":\"//BLA BLA\",\"description\":\"\"},{\"name\":\"onBeforeChange\",\"type\":\"BeforeChange\",\"expression\":\"//onBeforeChange\",\"description\":\"\"},{\"name\":\"onAfterChange\",\"type\":\"AfterChange\",\"expression\":\"//onAfterChange\",\"description\":\"\"},{\"name\":\"BeforeSave2\",\"type\":\"BeforeSave\",\"expression\":\"//BOLA\",\"description\":\"onBeforeSaveonBeforeSaveonBeforeSaveonBeforeSaveonBeforeSave OLE\"}],\"dataSource\":\"System\",\"description\":null}";
        private const string MenuMetadata = "{\"name\":\"DefaultApplicationMenu\",\"type\":\"Menu\",\"label\":\"Default menu\",\"elements\":[{\"row\":1,\"name\":\"Homepage\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Homepage\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"DarkGray\"},{\"key\":\"Icon\",\"value\":\"home\"},{\"key\":\"ActionType\",\"value\":\"Home\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":2,\"name\":\"Documents\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Documents\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"SeaGreen\"},{\"key\":\"Icon\",\"value\":\"file-text-o\"},{\"key\":\"IsFolder\",\"value\":\"true\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":3,\"name\":\"Configurations\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Configurations/\",\"column\":1,\"elements\":[{\"row\":1,\"name\":\"Customer\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Customer\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"DarkGray\"},{\"key\":\"Icon\",\"value\":\"cog\"},{\"key\":\"ActionLocation\",\"value\":\"Customer\"},{\"key\":\"ActionType\",\"value\":\"Agent\"}],\"behaviours\":[{\"name\":\"OnCustomerSelect\",\"type\":\"Select\",\"expression\":\"alert('onSelect_customer')\",\"description\":\"\"}],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"DarkGray\"},{\"key\":\"Icon\",\"value\":\"cog\"},{\"key\":\"IsFolder\",\"value\":\"false\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":4,\"name\":\"Dashboards\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Dashboards\",\"column\":1,\"elements\":[{\"row\":1,\"name\":\"OtherDashboard\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"OtherDashboard\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"LightPink\"},{\"key\":\"Icon\",\"value\":\"tachometer\"},{\"key\":\"ActionLocation\",\"value\":\"OtherDashboard\"},{\"key\":\"ActionType\",\"value\":\"Dashboard\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"LightPink\"},{\"key\":\"Icon\",\"value\":\"tachometer\"},{\"key\":\"IsFolder\",\"value\":\"true\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":5,\"name\":\"Series\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"Series\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"Color\",\"value\":\"MediumSlateBlue\"},{\"key\":\"Icon\",\"value\":\"sort-numeric-asc\"},{\"key\":\"IsFolder\",\"value\":\"true\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null},{\"row\":50,\"name\":\"OtherSection\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"OtherSection\",\"column\":1,\"elements\":[{\"row\":10,\"name\":\"OtherCustomer\",\"size\":12,\"type\":\"MenuEntry\",\"label\":\"OtherCustomer\",\"column\":1,\"elements\":[],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"actionType\",\"value\":\"Agent\"},{\"key\":\"isFolder\",\"value\":\"false\"},{\"key\":\"actionLocation\",\"value\":\"Customer\"},{\"key\":\"icon\",\"value\":\"link\"},{\"key\":\"color\",\"value\":\"DarkGray\"}],\"behaviours\":[{\"name\":\"OtherCustomervhg\",\"type\":\"Select\",\"expression\":\"//\",\"description\":\"\"}],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"isHidden\":false,\"attributes\":[{\"key\":\"actionType\",\"value\":\"Folder\"},{\"key\":\"isFolder\",\"value\":\"true\"},{\"key\":\"icon\",\"value\":\"link\"},{\"key\":\"color\",\"value\":\"DarkGray\"}],\"behaviours\":[],\"description\":null,\"visibleFrom\":null}],\"helpText\":null,\"attributes\":[{\"key\":\"Generated\",\"value\":\"false\"}],\"behaviours\":[],\"description\":\"Generated default menu\"}";

        [Theory]
        [InlineData("_code", "/elements/0")]
        [InlineData("_name", "/elements/1")]
        public void Find_TopLevelElements_Successful(string element, string expectedPath)
        {
            var finder = new FormElementPathFinder((JObject)JsonConvert.DeserializeObject(FormMetadata));

            var path = finder.Find("CustomerForm", element);

            path.ShouldBe(expectedPath);
        }

        [Fact]
        public void Find_ChildLevelElements_Successful()
        {
            var finder = new FormElementPathFinder((JObject)JsonConvert.DeserializeObject(FormMetadata));

            var path = finder.Find("NoteList", "_code");

            path.ShouldBe("/elements/7/elements/0");
        }

        [Fact]
        public void Find_ChildLevelElementsUsingDifferentCasing_Successful()
        {
            var finder = new FormElementPathFinder((JObject)JsonConvert.DeserializeObject(FormMetadata));

            var path = finder.Find("NOTELIST", "_CODE");

            path.ShouldBe("/elements/7/elements/0");
        }

        [Fact]
        public void Find_InnerChildLevelElements_Successful()
        {
            var finder = new FormElementPathFinder((JObject)JsonConvert.DeserializeObject(FormMetadata));

            var path = finder.Find("SubNotes", "_code");

            path.ShouldBe("/elements/7/elements/4/elements/0");
        }

        [Theory]
        [InlineData("customer", "/elements/2/elements/0")]
        [InlineData("OtherCustomer", "/elements/5/elements/0")]
        public void Find_WithMenuTopLevelElements_Successful(string element, string expectedPath)
        {
            var finder = new FormElementPathFinder((JObject)JsonConvert.DeserializeObject(MenuMetadata));

            var path = finder.Find("DefaultApplicationMenu", element);

            path.ShouldBe(expectedPath);
        }
    }
}
